<div class="order-detail-container">
  <h1>Rendelés részletei</h1>

  <!-- Betöltés jelző -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Hiba üzenet -->
  <div *ngIf="error" class="error-container">
    <mat-card class="error-card">
      <mat-card-content>
        <p>{{ error }}</p>
        <button mat-button color="primary" (click)="goBack()">Vissza a rendelésekhez</button>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Rendelés részletei -->
  <div *ngIf="order && !loading && !error" class="order-content">
    <mat-card>
      <mat-card-header>
        <div class="order-header">
          <h2>Rendelés #{{ order.id }}</h2>
          <div class="order-status" [ngClass]="getStatusClass(order.status)">
            {{ getStatusText(order.status) }}
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="order-info">
          <div class="info-section">
            <h3>Általános információk</h3>
            <p><strong>Rendelés ideje:</strong> {{ order.createdAt | date:'yyyy. MM. dd. HH:mm' }}</p>
            <p><strong>Utolsó módosítás:</strong> {{ order.updatedAt | date:'yyyy. MM. dd. HH:mm' }}</p>
            <p><strong>Rendelés azonosítója:</strong> {{ order.id }}</p>
            <p><strong>Megrendelő:</strong> {{ order.userName }}</p>
            <p><strong>Végösszeg:</strong> {{ order.totalAmount | number:'1.0-0' }} Ft</p>
          </div>

          <div class="info-section" *ngIf="order.shippingAddress">
            <h3>Szállítási információk</h3>
            <p><strong>Név:</strong> {{ order.shippingAddress.fullName }}</p>
            <p><strong>Cím:</strong> {{ order.shippingAddress.address }}</p>
            <p><strong>Város:</strong> {{ order.shippingAddress.city }}</p>
            <p><strong>Irányítószám:</strong> {{ order.shippingAddress.postalCode }}</p>
            <p *ngIf="order.shippingAddress.phoneNumber">
              <strong>Telefonszám:</strong> {{ order.shippingAddress.phoneNumber }}
            </p>
          </div>
        </div>

        <div class="order-items">
          <h3>Rendelt termékek</h3>
          <table mat-table [dataSource]="order.items" class="mat-elevation-z2">
            <!-- Termék neve oszlop -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Termék</th>
              <td mat-cell *matCellDef="let item">{{ item.part.name }}</td>
            </ng-container>

            <!-- Mennyiség oszlop -->
            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Mennyiség</th>
              <td mat-cell *matCellDef="let item">{{ item.quantity }} db</td>
            </ng-container>

            <!-- Egységár oszlop -->
            <ng-container matColumnDef="unitPrice">
              <th mat-header-cell *matHeaderCellDef>Egységár</th>
              <td mat-cell *matCellDef="let item">{{ item.part.price | number:'1.0-0' }} Ft</td>
            </ng-container>

            <!-- Összár oszlop -->
            <ng-container matColumnDef="totalPrice">
              <th mat-header-cell *matHeaderCellDef>Összár</th>
              <td mat-cell *matCellDef="let item">{{ item.part.price * item.quantity | number:'1.0-0' }} Ft</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['name', 'quantity', 'unitPrice', 'totalPrice']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['name', 'quantity', 'unitPrice', 'totalPrice']"></tr>
          </table>

          <div class="order-total">
            <span>Végösszeg:</span>
            <span class="total-amount">{{ order.totalAmount | number:'1.0-0' }} Ft</span>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <!-- Admin funkció: státusz frissítése -->
        <div class="status-update-container">
          <button mat-flat-button color="primary" (click)="goBack()">
            <mat-icon>arrow_back</mat-icon> Vissza a rendelésekhez
          </button>
          
          <!-- Csak admin felhasználók láthatják a státuszfrissítést -->
          <div class="status-buttons" *ngIf="(isAdmin$ | async) && order.status !== orderStatuses.DELIVERED && order.status !== orderStatuses.CANCELLED">
            <h3>Admin funkciók</h3>
            <button mat-flat-button color="accent" [disabled]="order.status === orderStatuses.PROCESSING" 
                   (click)="updateOrderStatus(orderStatuses.PROCESSING)">
              <mat-icon>update</mat-icon> Feldolgozás alatt
            </button>
            <button mat-flat-button color="accent" [disabled]="order.status === orderStatuses.SHIPPED" 
                   (click)="updateOrderStatus(orderStatuses.SHIPPED)">
              <mat-icon>local_shipping</mat-icon> Kiszállítva
            </button>
            <button mat-flat-button color="accent" 
                   (click)="updateOrderStatus(orderStatuses.DELIVERED)">
              <mat-icon>check_circle</mat-icon> Kézbesítve
            </button>
            <button mat-flat-button color="warn" 
                   (click)="updateOrderStatus(orderStatuses.CANCELLED)">
              <mat-icon>cancel</mat-icon> Visszavonva
            </button>
          </div>
        </div>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
